name: Release

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

# è®¾ç½®å¿…è¦çš„æƒé™
permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    
    # ä¸ºè¿™ä¸ªjobè®¾ç½®æƒé™
    permissions:
      contents: write
      issues: write
      pull-requests: write
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'

    - name: Get version from version.go
      id: get_version
      run: |
        VERSION=$(grep 'const Version = ' version.go | sed 's/.*"\(.*\)".*/\1/')
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "Version: ${VERSION}"

    - name: Check if tag exists
      id: check_tag
      run: |
        if git tag -l "v${{ steps.get_version.outputs.version }}" | grep -q "v${{ steps.get_version.outputs.version }}"; then
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "exists=false" >> $GITHUB_OUTPUT
        fi

    - name: Build binaries
      if: steps.check_tag.outputs.exists == 'false'
      run: |
        mkdir -p dist
        
        # è·å–æ„å»ºä¿¡æ¯
        BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        GIT_COMMIT=$(git rev-parse --short HEAD)
        
        # æ„å»ºä¸åŒå¹³å°çš„äºŒè¿›åˆ¶æ–‡ä»¶
        platforms=(
          "linux/amd64"
          "linux/arm64"
          "darwin/amd64"
          "darwin/arm64"
          "windows/amd64"
          "windows/arm64"
        )
        
        for platform in "${platforms[@]}"; do
          IFS='/' read -r os arch <<< "$platform"
          output_name="cosp-v${{ steps.get_version.outputs.version }}-${os}-${arch}"
          
          if [ "$os" = "windows" ]; then
            output_name="${output_name}.exe"
          fi
          
          echo "Building for $os/$arch..."
          CGO_ENABLED=0 GOOS=$os GOARCH=$arch go build \
            -ldflags "-s -w -X main.BuildTime=${BUILD_TIME} -X main.GitCommit=${GIT_COMMIT}" \
            -o "dist/${output_name}" .
        done
        
        # åˆ›å»ºæ ¡éªŒå’Œæ–‡ä»¶
        cd dist
        sha256sum * > checksums.txt
        cd ..

    - name: Create Release Notes
      if: steps.check_tag.outputs.exists == 'false'
      run: |
        cat > release_notes.md << EOF
        ## COSP v${{ steps.get_version.outputs.version }}

        ### ğŸ“¦ ä¸‹è½½

        é€‰æ‹©é€‚åˆæ‚¨æ“ä½œç³»ç»Ÿçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼š

        - **Linux**: \`cosp-v${{ steps.get_version.outputs.version }}-linux-amd64\` (x86_64) æˆ– \`cosp-v${{ steps.get_version.outputs.version }}-linux-arm64\` (ARM64)
        - **macOS**: \`cosp-v${{ steps.get_version.outputs.version }}-darwin-amd64\` (Intel) æˆ– \`cosp-v${{ steps.get_version.outputs.version }}-darwin-arm64\` (Apple Silicon)
        - **Windows**: \`cosp-v${{ steps.get_version.outputs.version }}-windows-amd64.exe\` (x86_64) æˆ– \`cosp-v${{ steps.get_version.outputs.version }}-windows-arm64.exe\` (ARM64)

        ### ğŸ” å®‰å…¨æ€§

        æ‰€æœ‰äºŒè¿›åˆ¶æ–‡ä»¶çš„ SHA256 æ ¡éªŒå’Œéƒ½åŒ…å«åœ¨ \`checksums.txt\` æ–‡ä»¶ä¸­ã€‚

        ### ğŸ“‹ æ›´æ–°å†…å®¹

        - è‡ªåŠ¨æ„å»ºå‘å¸ƒ
        - æ”¯æŒå¤šå¹³å°äºŒè¿›åˆ¶æ–‡ä»¶
        - åŒ…å«æ„å»ºæ—¶é—´å’Œ Git æäº¤ä¿¡æ¯

        ### ğŸš€ ä½¿ç”¨æ–¹æ³•

        1. ä¸‹è½½é€‚åˆæ‚¨å¹³å°çš„äºŒè¿›åˆ¶æ–‡ä»¶
        2. é‡å‘½åä¸º \`cosp\`ï¼ˆLinux/macOSï¼‰æˆ– \`cosp.exe\`ï¼ˆWindowsï¼‰
        3. æ·»åŠ åˆ°ç³»ç»Ÿ PATH ä¸­
        4. è¿è¡Œ \`cosp version\` æŸ¥çœ‹ç‰ˆæœ¬ä¿¡æ¯

        å®Œæ•´çš„ä½¿ç”¨è¯´æ˜è¯·å‚è€ƒ [README.md](https://github.com/bwangelme/cosp/blob/master/README.md)
        EOF

    - name: Create Release
      if: steps.check_tag.outputs.exists == 'false'
      run: |
        gh release create v${{ steps.get_version.outputs.version }} \
          --title "Release v${{ steps.get_version.outputs.version }}" \
          --notes-file release_notes.md \
          dist/*
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  test:
    name: Test
    runs-on: ubuntu-latest
    
    # æµ‹è¯•jobä¸éœ€è¦ç‰¹æ®Šæƒé™ï¼Œä½¿ç”¨é»˜è®¤çš„readæƒé™
    permissions:
      contents: read
    
    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'

    - name: Test
      run: go test -v ./...

    - name: Build
      run: go build -v ./...

    - name: Test version command
      run: |
        go run . version 